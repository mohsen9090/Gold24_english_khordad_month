<?php session_start();error_reporting(E_ALL);ini_set('display_errors',1);ini_set('log_errors',1);ini_set('error_log',__DIR__.'/error.log');$db_config=['host'=>'localhost','user'=>'gold24_user','pass'=>'random_password','name'=>'gold24_db'];try{$conn=new mysqli($db_config['host'],$db_config['user'],$db_config['pass'],$db_config['name']);$conn->set_charset("utf8mb4");if($conn->connect_error){throw new Exception("خطای اتصال به دیتابیس: ".$conn->connect_error);}$error='';$success='';if($_SERVER['REQUEST_METHOD']=='POST'){$action=$_POST['action']??'';$email=filter_var($_POST['email']??'',FILTER_SANITIZE_EMAIL);$password=$_POST['password']??'';$captcha=trim($_POST['captcha']??'');if(!isset($_SESSION['captcha'])||(string)$captcha!==(string)$_SESSION['captcha']){throw new Exception("کد امنیتی نادرست است");}if($action=='register'){$name=trim($_POST['name']??'');$uid=trim($_POST['uid']??'');$confirm_password=$_POST['confirm_password']??'';if(empty($name)||empty($uid)||empty($confirm_password)){throw new Exception("تمامی فیلدها الزامی هستند");}if(!preg_match('/^[a-zA-Z]+$/',$name)){throw new Exception("نام فقط باید شامل حروف انگلیسی باشد");}if(!preg_match('/^\d+$/',$uid)){throw new Exception("کد کاربری فقط باید شامل اعداد باشد");}if($password!==$confirm_password){throw new Exception("رمز عبور و تکرار آن مطابقت ندارند");}$stmt=$conn->prepare("SELECT id FROM users WHERE email=? OR uid=?");$stmt->bind_param("ss",$email,$uid);$stmt->execute();if($stmt->get_result()->num_rows>0){throw new Exception("این ایمیل یا کد کاربری قبلاً ثبت شده است");}$stmt->close();$hashed_password=password_hash($password,PASSWORD_DEFAULT);$user_uid=uniqid();$stmt=$conn->prepare("INSERT INTO users (name,email,password,uid,user_uid) VALUES (?,?,?,?,?)");$stmt->bind_param("sssss",$name,$email,$hashed_password,$uid,$user_uid);if($stmt->execute()){$_SESSION['register_success']=true;if(!headers_sent()){header("Location: index.php?success=1");exit();}else{echo"<script>window.location.href='index.php?success=1';</script>";exit();}}else{throw new Exception("خطا در ثبت نام: ".$stmt->error);}$stmt->close();}elseif($action=='login'){if(empty($email)||empty($password)){throw new Exception("لطفا همه فیلدها را پر کنید");}$stmt=$conn->prepare("SELECT id,name,password,user_uid FROM users WHERE email=? LIMIT 1");if(!$stmt){throw new Exception("خطای دیتابیس: ".$conn->error);}$stmt->bind_param("s",$email);$stmt->execute();$result=$stmt->get_result();if($user=$result->fetch_assoc()){if(password_verify($password,$user['password'])){$_SESSION['user_id']=$user['id'];$_SESSION['user_name']=$user['name'];$_SESSION['user_uid']=$user['user_uid'];$_SESSION['email']=$email;$_SESSION['username']=$user['name'];if(!headers_sent()){header("Location: /English/index.php");exit();}else{echo"<script>window.location.href='/English/index.php';</script>";exit();}}else{throw new Exception("ایمیل یا رمز عبور اشتباه است");}}else{throw new Exception("ایمیل یا رمز عبور اشتباه است");}$stmt->close();}}$_SESSION['captcha']=sprintf('%04d',rand(0,9999));}catch(Exception$e){error_log("Auth Error: ".$e->getMessage());$error=$e->getMessage();}finally{if(isset($conn)){$conn->close();}}?><!DOCTYPE html><html lang="fa" dir="rtl"><head><meta charset="UTF-8"><meta name="viewport" content="width=device-width,initial-scale=1.0"><title>ورود و ثبت نام</title><style>:root{--primary:#8B0000;--secondary:#A52A2A;--accent:#FFD700;--background:#1C1C1C;--card-bg:#2B1B17;--text:#FFF}*{box-sizing:border-box;margin:0;padding:0;font-family:system-ui,-apple-system,BlinkMacSystemFont,'Segoe UI',Roboto,sans-serif}body{background:var(--background);min-height:100vh;display:flex;align-items:center;justify-content:center;color:var(--text);padding:20px}.container{display:flex;gap:20px;width:100%;max-width:1000px;margin:0 auto}.auth-box{background:var(--card-bg);padding:30px;border-radius:15px;border:1px solid var(--accent);flex:1}.auth-title{color:var(--accent);text-align:center;margin-bottom:25px;font-size:24px;font-weight:bold}.input-group{margin-bottom:15px}.input{width:100%;padding:12px;background:rgba(255,255,255,0.05);border:1px solid #555;border-radius:8px;color:var(--text);font-size:16px;transition:all 0.3s ease}.input:focus{border-color:var(--accent);outline:none;box-shadow:0 0 10px rgba(255,215,0,0.1)}.captcha{background:linear-gradient(45deg,var(--primary),var(--secondary));color:var(--accent);padding:15px;text-align:center;margin:15px 0;font-family:monospace;font-size:24px;font-weight:bold;border-radius:8px;user-select:none;border:1px solid var(--accent)}.button{width:100%;padding:12px;border:none;border-radius:8px;cursor:pointer;font-size:16px;font-weight:bold;transition:all 0.3s ease;margin-top:15px}.button-primary{background:linear-gradient(45deg,var(--primary),var(--secondary));color:var(--accent);border:1px solid var(--accent)}.button-primary:hover{transform:translateY(-2px);box-shadow:0 5px 15px rgba(255,215,0,0.2)}.message{padding:12px;border-radius:8px;margin:15px 0;text-align:center}.error{background:rgba(255,0,0,0.1);border:1px solid rgba(255,0,0,0.2);color:#ff4444}.success{background:rgba(0,255,0,0.1);border:1px solid rgba(0,255,0,0.2);color:#4CAF50}@media(max-width:768px){.container{flex-direction:column}.auth-box{width:100%}}</style></head><body><div class="container"><div class="auth-box"><h2 class="auth-title">ورود به سیستم</h2><?php if(isset($_GET['success'])):?><div class="message success">ثبت نام با موفقیت انجام شد. لطفاً وارد شوید.</div><?php endif;?><form method="POST" onsubmit="return validateLoginForm()"><input type="hidden" name="action" value="login"><div class="input-group"><input type="email" name="email" placeholder="ایمیل" required class="input"></div><div class="input-group"><input type="password" name="password" placeholder="رمز عبور" required class="input"></div><div class="captcha"><?=$_SESSION['captcha']?></div><input type="text" name="captcha" placeholder="کد امنیتی بالا را وارد کنید" required class="input"><button type="submit" class="button button-primary">ورود</button><?php if($error&&isset($_POST['action'])&&$_POST['action']=='login'):?><div class="message error"><?=htmlspecialchars($error)?></div><?php endif;?></form></div><div class="auth-box"><h2 class="auth-title">ثبت نام</h2><form method="POST" onsubmit="return validateRegisterForm()"><input type="hidden" name="action" value="register"><div class="input-group"><input type="text" name="name" placeholder="نام (به انگلیسی)" required class="input"></div><div class="input-group"><input type="text" name="uid" placeholder="کد کاربری (فقط عدد)" required class="input"></div><div class="input-group"><input type="email" name="email" placeholder="ایمیل" required class="input"></div><div class="input-group"><input type="password" name="password" placeholder="رمز عبور" required class="input"></div><div class="input-group"><input type="password" name="confirm_password" placeholder="تکرار رمز عبور" required class="input"></div><div class="captcha"><?=$_SESSION['captcha']?></div><input type="text" name="captcha" placeholder="کد امنیتی بالا را وارد کنید" required class="input"><button type="submit" class="button button-primary">ثبت نام</button><?php if($error&&isset($_POST['action'])&&$_POST['action']=='register'):?><div class="message error"><?=htmlspecialchars($error)?></div><?php endif;?></form></div></div><script>function validateLoginForm(){const email=document.querySelector('form[action="login"] input[name="email"]').value;const password=document.querySelector('form[action="login"] input[name="password"]').value;const captcha=document.querySelector('form[action="login"] input[name="captcha"]').value;if(!email||!password||!captcha){alert('لطفا همه فیلدها را پر کنید');return false;}if(!email.includes('@')){alert('لطفا یک ایمیل معتبر وارد کنید');return false;}return true;}function validateRegisterForm(){const name=document.querySelector('form[action="register"] input[name="name"]').value;const uid=document.querySelector('form[action="register"] input[name="uid"]').value;const email=document.querySelector('form[action="register"] input[name="email"]').value;const password=document.querySelector('form[action="register"] input[name="password"]').value;const confirmPassword=document.querySelector('form[action="register"] input[name="confirm_password"]').value;const captcha=document.querySelector('form[action="register"] input[name="captcha"]').value;if(!name||!uid||!email||!password||!confirmPassword||!captcha){alert('لطفا همه فیلدها را پر کنید');return false;}if(!/^[a-zA-Z]+$/.test(name)){alert('نام فقط باید شامل حروف انگلیسی باشد');return false;}if(!/^\d+$/.test(uid)){alert('کد کاربری فقط باید شامل اعداد باشد');return false;}if(!email.includes('@')){alert('لطفا یک ایمیل معتبر وارد کنید');return false;}if(password!==confirmPassword){alert('رمز عبور و تکرار آن مطابقت ندارند');return false;}return true;}</script></body></html>
